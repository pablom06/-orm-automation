name: ORM Content Publisher

on:
  # Run daily at 9:00 AM EST (14:00 UTC)
  schedule:
    - cron: '0 14 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (preview without publishing)'
        required: false
        type: boolean
        default: false
      day:
        description: 'Specific day to publish (1-30, leave empty for today)'
        required: false
        type: string

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run publisher
        env:
          MEDIUM_TOKEN: ${{ secrets.MEDIUM_TOKEN }}
          MEDIUM_USER_ID: ${{ secrets.MEDIUM_USER_ID }}
          START_DATE: ${{ vars.START_DATE || '2026-02-11' }}
          FREQUENCY: ${{ vars.FREQUENCY || 'daily' }}
          PUBLISH_TIME: ${{ vars.PUBLISH_TIME || '09:00' }}
          AUTO_OPEN_LINKEDIN: 'false'  # Disable browser opening in CI
        run: |
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            python publish.py --dry-run
          elif [ -n "${{ github.event.inputs.day }}" ]; then
            python publish.py --day ${{ github.event.inputs.day }}
          else
            python publish.py
          fi

      - name: Commit and push status updates
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update publishing status [skip ci]"
          file_pattern: "logs/publish_status.json logs/publish.log"
          commit_user_name: "ORM Publisher Bot"
          commit_user_email: "actions@github.com"
